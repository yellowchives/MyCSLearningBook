# 计算机网络

## 如何接入网络

互联网的入口线路称为接入网。一般来说，我们可以用电话线、ISDN、ADSL、有线电视、光线、专线等多种通信线路来接入互联网，这些通信线路统称为接入网。接入网连接到签约的网络运营商，并接入被称为接入点（Point of Presence, PoP）的设备。

接入点的实体是一台专为运营商设计的路由器，我们可以把它理解为离你家最近的邮局。从各个邮筒中收集来的信件会在邮局进行分拣，然后被送往全国甚至全世界，互联网也是一样，网络包首先通过接入网被发送到接入点，然后再从这里被发送到全国甚至全世界。接入点的后面就是互联网的骨干部分了。

区分点对点（point to point）和端对端（end to end）。点对点是物理上的两台主机直接相连，端对端是逻辑上的两台主机相连，将途径的路由器等转发设备当成虚拟的一条线路。TCP协议建立的就是端对端的可靠连接。

通过url访问一个网络，需要17次通信：

1. 6次通信用于获取ip地址
2. 3次通信用户建立tcp连接
3. http请求需要4次
4. 结束tcp连接需要4次

## 物理层

### 复用技术

复用技术可以让多个用户使用同一条线路进行通信。复用技术需要解决干线起点如何共用，干线终点如何分离的问题。

1. 频分多路复用 FDM （Frequency Division  Multiplexing）：信道的频谱被分成若干段（子带）， 每个用户占据一段来传输自己的信号。相邻用户使用的频段（子带）之间，通常留有一定的 带宽，以免混淆，这个频段被称作保护带。一种更好地利用带宽的FDM叫正交频分多路复用 OFDM。OFDM没有了保护带，且子带之间相互重叠；同样的干线可以承载更多的用户。OFDM 已被广泛用于802.11、有线电视网络等。
2. 波分多路复用 WDM (Wavelength Division Multiplexing)：按照不同的波长，干线分成了若干份，承载了不同用户的光信号。
3. 时分多路复用TDM（Time  Division Multiplexing）：将时间划分为非常短的时间片， 每个用户周期性地在自己的时间片内使用整个带宽。广泛用于 电话系统和蜂窝系统系统。
4. 码分多路复用CDMA （Code Division Multiple Access）：广泛用于移动网络。

### 统计复用 Statistical Multiplexing

Data is transmitted based on demand of each flow. 流量大的连接多占用带宽，流量小的少占用带宽。有下面几种带宽分配的规则：

1. FIFO：只有一个队列，先进先出。
2. Round-Robin：每个主机都有自己的一个队列，第一个队列先发出一个包，然后第二个队列也发出一个包，以此类推，不断循环。相对FIFO，兼顾了公平。
3. Priorities (Quality-of-Service (QoS))：不同的主机有不同的权限。

<img src="计算机网络.assets/Snipaste_2022-04-17_23-34-04.png"  />

### 调制技术

调制技术完成数字信号到模拟信息的转换。

## TCP/IP 四层架构

![](计算机网络.assets/Snipaste_2022-04-17_23-58-40.png)

自上而下分别是：应用层Application、传输层Transport、网络层Network、链接层Link（数据链路层 + 物理层）。

网络层使用的IP协议是不可靠的。运输层的TCP协议在不可靠的IP协议提供的服务之上建立的可靠的连接，FTP、HTTP等应用层协议都是用TCP协议来传输数据。UDP协议是不可靠的，无连接的，所以响应的速度比较快，DNS服务使用UDP协议。

## OSI 参考模型

分成7层：

![](计算机网络.assets/Snipaste_2022-04-18_21-17-43.jpg)

交换机和路由器的区别是交换机是交换机是第二层的设备，而路由器是第3层的设备。所以交换机是不看IP的，只看网卡地址，一般用于内网。而路由器可以查看IP，用于网络之间的通信。

## 数据链路层和物理层（链接层Link）

数据链路层的传送的单位是一个Frame，会加上头尾。作用是将帧传送给直接相连的主机，header加上了MAC地址，tailer加上了差错检测的bit。数据链路层的协议统称为MAC协议(Media Access Control Protocol)，主要包括以太网使用的CSMA/CD协议和Wireless LAN使用的CSMA/CA协议。

物理层规定了具体的传输介质的选择。

我们常说的Eternet、WLAN、5G等都是具体的链接层技术。

###  Eternet

最流行的CSMA/CD协议采用了下面的措施：

1. 无连接。对传送的数据帧不进行编号，也不要求对方发回确认。当检测到差错时，直接丢弃差错帧，其他什么都不做。至于差错帧是否重传交给高层决定，如果是TCP协议，就由TCP协议来检测是否丢失数据并重传。
2. 碰撞检测。早期Ethernet使用总线型网络，总线型网络都是多点接入（multiple access），如果一条总线上有主机在发送数据，其他主机同时发送数据就会产生冲突。以太网数据链路层采用了CSMA/CD协议，每个主机在发送前都要检测信道，只有当信道空闲（idle）时才能发送。现在以太网都是星型结构，主机连接到交换机上，交换机彼此相连，不会发生冲突了，但是还是继续使用CSMA/CD协议。
3. 采用曼彻斯特编码。如果我们使用高电位代表1，低电位代表0，那么当出现连续的高电位就分不清楚到底有几个比特1了，这就是比特不同步。经常出现的问题就是发送bit的速度和接受bit的速度不一样。曼彻斯特编码解决了这个问题，他把一个码元再次分成两个间隔，如果从低电压变为高电压就代表码元1，反之为0。

以太网帧的结构：

![](计算机网络.assets/Snipaste_2022-04-20_20-52-14.png)

Preamble用来同步接受和发送bit的速率，SFD标记数据的开始，LLC就是传送的数据，最少46个字节，不足就用PAD补足。FCS是数据计算出来的校验值，类似MD5，用来判断传送的数据是否出错。以太网是不可靠的协议，如果帧出错了就直接丢弃，不会重传。

DA代表目的地的网卡地址。以太网传送的方式都是广播，其他主机会解析DA，如果和自己的不一样就不接收。而嗅探的原理就是无视DA，接受局域网中所有的数据。如果DA的bit都是1，就是一个 broadcast address，代表局域网中所有主机都可以接受数据。如果DA的第一个bit是1，就是一个群播地址（multicast address），这个群中的所有主机都可以接收数据。

MAC地址绑定在网卡上（不是主机），长六个字节，字节之间使用冒号隔开。不同公司生产的网卡前缀也不一样，比如 `8:0:20:e4:b1:2`就是一个AMD的网卡，AMD网卡的前三个字节都是一样的。ipconfig/all 可以查看本机的网卡地址，这台电脑有两块Realtek网卡，一块虚拟机的以太网网卡，一块因特尔的无线网卡。

###  Wireless LAN

## 网络层

网络层很特殊，其上只有一个协议：Internet Protocol，俗称IP协议。我们现在使用的因特网的名字就是来源于IP协议。

IP协议发送的包叫做datagram，是无连接的，IP协议会尽力传送数据包到另一端，但是不能保证正确。是否出现差错，需要依赖TCP协议来确定。

IP的不可靠体现在以下情况：

1. 路由器阻塞时会丢包，而IP不会重传
2. 数据包可能被复制，IP无法确定
3. 每个数据包所走的路径不同，到达的顺序会乱
4. 路由器的转发表错误，导致数据包被发送到了错误的目的地
5. 数据包的bit错误

在通信中，有一个端到端原则：**如果能在端上实现的，就要在端上实现**。所以IP协议设计的非常简单，不提供可靠的服务，因为可靠的服务可以在主机上实现。

IP不会自动重传可以确保及时性，对于直播这样的应用很重要。

### IP协议细节

1. 阻止数据包循环：
   数据包从一个路由器到下一个路由器称为一跳(a hop)。为了防止数据包循环，IP协议会添加生存时间或TTL字段

2. 将大packet分割发送：

   IP会根据数据链路层的要求分割packet

3. IP数据包的首部有一个校验和：
   防止发错目的地

4. 允许添加新的首部字段

#### IPV4

Protocol ID告知使用的传输协议。如果为6，代表了Data里有一个TCP segment。目前有140多种ID。

version 代表使用的版本，可以选择IPV4和IPV6。

TTL从128开始，每一跳就减一，如果减到0就丢掉数据包。

Flags，Fragment Offset帮助路由器将数据包分片成更小的（如果需要的）自包含数据包。

Checksum是整个header的校验和。

<img src="计算机网络.assets/Snipaste_2022-05-19_23-28-46.jpg" style="zoom:50%;" />

## 应用层

### Http协议

### skype

skype协议采用了一些方法让在NAT之后的两台主机也可以通信。

如果一台主机在NAT之后，它可以向其他主机发起连接，但是其他主机不能向他发起连接。